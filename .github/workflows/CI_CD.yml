name: Deploy Automático - Next.js (Produção)

on:
  push:
    branches:
      - main

jobs:
  build_e_deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Build do Next.js
        run: |
          BUILD_DIR="/var/www/site"

          echo "--- Copiando código para diretório de build..."
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"
          cp -r . "$BUILD_DIR/"

          cd "$BUILD_DIR"

          echo "--- Instalando dependências..."
          npm ci

          echo "--- Build do Next.js..."
          npm run build

      - name: Deploy e Restart Next.js
        run: |
          PROD_DIR="/var/www/html/site"
          BUILD_DIR="/var/www/site"
          APP_NAME="next-site"
          PORT=3000

          echo "--- Preparando diretório de produção..."
          rm -rf "$PROD_DIR"
          mkdir -p "$PROD_DIR"

          echo "--- Copiando arquivos necessários..."
          cp -r "$BUILD_DIR/.next" "$PROD_DIR/"
          cp -r "$BUILD_DIR/public" "$PROD_DIR/" 2>/dev/null || true
          cp "$BUILD_DIR/package.json" "$PROD_DIR/"
          cp "$BUILD_DIR/package-lock.json" "$PROD_DIR/"
          cp "$BUILD_DIR/next.config.js" "$PROD_DIR/" 2>/dev/null || true

          cd "$PROD_DIR"

          echo "--- Instalando dependências de produção..."
          npm ci --omit=dev

          echo "--- Reiniciando aplicação com PM2..."
          pm2 delete "$APP_NAME" 2>/dev/null || true

          pm2 start npm --name "$APP_NAME" -- start -- -p $PORT

          pm2 save

          echo "✅ Deploy concluído!"